{% extends 'base.html' %}
{% load static i18n core_tags %}

{% block title %}Dashboard - {{ user_role }}{% endblock %}

{% block content %}
<nav class="navbar navbar-expand-lg navbar-light bg-transparent py-4 px-4">
    <div class="d-flex align-items-center">
        <h2 class="fs-2 m-0 fw-bold">{{ "Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…"|smart_trans }}</h2>
        <span class="badge {% if is_manager %}bg-primary{% else %}bg-success{% endif %} ms-3">{{ user_role }}</span>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© (ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…) -->
    {% if is_manager %}
    <div class="ms-auto">
        <a href="{% url 'core:branch_list' %}" class="btn btn-outline-dark me-2">
            <i class="bi bi-shop"></i> {{ "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙˆØ¹"|smart_trans }}
        </a>
        <button class="btn btn-primary rounded-pill px-4">
            <i class="bi bi-plus-lg"></i> {{ "Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¹ Ø¬Ø¯ÙŠØ¯"|smart_trans }}
        </button>
    </div>
    {% endif %}
</nav>

<div class="container-fluid px-4">

    <div class="row g-4 my-2">
        <!-- Stats Column -->
        <div class="col-lg-8">
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="stat-card">
                        <div>
                            <p class="text-muted mb-1 fw-bold">{{ "Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ù†Ø´Ø·Ø©"|smart_trans }}</p>
                            <h2 class="fw-bold mb-0">{{ total_branches }}</h2>
                        </div>
                        <div class="icon-box bg-info bg-opacity-10 text-info">
                            <i class="bi bi-shop"></i>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="stat-card" style="border-right-color: #e74c3c;">
                        <div>
                            <p class="text-muted mb-1 fw-bold">{{ "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‡Ø¯Ø± Ø§Ù„Ù…Ø§Ù„ÙŠ"|smart_trans }}</p>
                            <h2 class="fw-bold mb-0 text-danger">{{ total_potential_loss }} Ø±.Ø³</h2>
                        </div>
                        <div class="icon-box bg-danger bg-opacity-10 text-danger">
                            <i class="bi bi-graph-down"></i>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="stat-card" style="border-right-color: #f1c40f;">
                        <div>
                            <p class="text-muted mb-1 fw-bold">{{ "Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©"|smart_trans }}</p>
                            <h2 class="fw-bold mb-0">{{ pending_requests|length }}</h2>
                        </div>
                        <div class="icon-box bg-warning bg-opacity-10 text-warning">
                            <i class="bi bi-inbox"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications Center Column -->
        <div class="col-lg-4">
            <div class="content-panel h-100 p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold m-0">ğŸ”” {{ "Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª"|smart_trans }}</h5>
                    {% if unread_notifications_count > 0 %}
                    <span id="notificationCount" class="badge bg-danger rounded-pill">{{ unread_notifications_count }}</span>
                    {% endif %}
                </div>

                <div style="max-height: 250px; overflow-y: auto;" class="pe-2">
                    <!-- Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… -->
                    {% for notification in notifications %}
                    <div
                        class="notification-item {% if not notification.is_read %}unread{% endif %} p-2 mb-2 rounded border bg-light">
                        <div class="d-flex align-items-start">
                            <div class="me-3 mt-1">
                                {% if notification.notification_type == 'system_update' %}
                                <i class="bi bi-arrow-up-circle text-info fs-4"></i>
                                {% elif notification.notification_type == 'welcome' %}
                                <i class="bi bi-hand-thumbs-up text-success fs-4"></i>
                                {% elif notification.notification_type == 'alert' %}
                                <i class="bi bi-exclamation-triangle text-warning fs-4"></i>
                                {% else %}
                                <i class="bi bi-info-circle text-primary fs-4"></i>
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1 fw-bold">{{ notification.title }}</h6>
                                <p class="mb-1 small text-muted">{{ notification.message|truncatewords:10 }}</p>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <small class="text-muted" style="font-size: 0.75rem;">{{
                                        notification.created_at|timesince }} Ù…Ø¶Øª</small>
                                    <a href="{% url 'notifications:detail' notification.id %}"
                                        class="btn btn-sm btn-outline-primary py-0 px-2">
                                        <i class="bi bi-eye"></i> Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ† -->
                    {% for item in low_stock_items %}
                    <div class="notification-item stock-alert p-2 mb-2 rounded border bg-warning bg-opacity-10 alert-dismissible fade show" role="alert">
                        <div class="d-flex align-items-start">
                            <div class="me-3 mt-1">
                                <i class="bi bi-exclamation-triangle-fill text-warning fs-4"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <span class="badge bg-warning text-dark mb-1">Ù†Ù‚Øµ Ù…Ø®Ø²ÙˆÙ†</span>
                                        <h6 class="mb-0 fw-bold">{{ item.product.name }}</h6>
                                    </div>
                                    <button type="button" class="btn-close small ms-2" onclick="this.closest('.notification-item').remove()" aria-label="Close" style="font-size: 0.7rem;"></button>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-1">
                                    <span class="badge bg-secondary" style="font-size: 0.7rem;">{{ item.branch.name }}</span>
                                </div>
                                <p class="mb-1 small text-muted mt-1">
                                    Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <span class="text-danger fw-bold">{{ item.quantity|floatformat:2 }}</span>
                                    / Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰: <span class="fw-bold">{{ item.product.minimum_quantity }}</span>
                                </p>
                                <small class="text-muted" style="font-size: 0.75rem;">ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ…ÙˆÙŠÙ†</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    {% if not notifications and not low_stock_items %}
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-check-circle fs-1 text-success opacity-50"></i>
                        <p class="mt-2 small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø£Ùˆ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <style>
        .notification-item {
            transition: all 0.2s;
        }

        .notification-item:hover {
            background-color: #e9ecef !important;
            transform: translateX(-3px);
        }

        .notification-item.unread {
            background-color: #e3f2fd !important;
            border-right: 3px solid #2196f3 !important;
        }

        .notification-item.stock-alert {
            border-right: 3px solid #ffc107 !important;
        }
    </style>

    <div class="row my-5">
        <!-- Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ ÙˆÙ‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
        <div class="col-lg-8">
            <div class="content-panel h-100">
                <h5 class="fw-bold mb-4">ğŸ“Š {{ "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù‡Ø¯Ø± (Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª)"|smart_trans }}</h5>
                <div class="table-responsive">
                    <table class="table table-custom align-middle">
                        <thead class="bg-light">
                            <tr>
                                <th>Ø§Ù„ÙØ±Ø¹</th>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±</th>
                                <th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‡Ø¯Ø±</th>
                                <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for report in latest_reports %}
                            <tr>
                                <td class="fw-bold">{{ report.branch.name }}</td>
                                <td>{{ report.generated_date|date:"Y-m-d H:i" }}</td>
                                <td class="text-danger fw-bold">{{ report.total_waste_value }} Ø±.Ø³</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary">Ø¹Ø±Ø¶</button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ù‡Ø¯Ø± Ù…Ø³Ø¬Ù„Ø©.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="content-panel h-100">
                <h5 class="fw-bold mb-4">
                    {% if is_manager %}
                    âš¡ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹
                    {% else %}
                    âš¡ Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ù…Ø±Ø³Ù„Ø©
                    {% endif %}
                </h5>

                {% if is_manager %}
                <!-- Ù‚Ø§Ø¦Ù…Ø© Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø¯ÙŠØ± -->
                <div class="list-group list-group-flush">
                    {% for req in pending_requests %}
                    <div class="list-group-item px-0">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold">{{ req.branch.name }}</span>
                            <small class="text-muted">{{ req.created_at|date:"m-d" }}</small>
                        </div>
                        <p class="mb-2 text-muted small">{{ req.type }}</p>
                        <a href="/operations/review/{{ req.id }}/approve/"
                            class="btn btn-sm btn-success w-100 rounded-pill">
                            Ù…ÙˆØ§ÙÙ‚Ø©
                        </a>
                    </div>
                    {% empty %}
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-check2-all fs-1"></i>
                        <p class="mt-2 text-small">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ø§Ù„Ø¬Ø©</p>
                    </div>
                    {% endfor %}
                </div>

                {% else %}
                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø¹Ø±Ø¶ ÙÙ‚Ø· Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹ -->
                <div class="list-group list-group-flush">
                    {% for req in my_requests %}
                    <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ req.type }}</strong>
                            <br>
                            <small class="text-muted">{{ req.created_at|date:"m-d" }}</small>
                        </div>
                        {% if req.status == 'PENDING' %}
                        <span class="badge bg-warning text-dark">Ø§Ù†ØªØ¸Ø§Ø±</span>
                        {% elif req.status == 'APPROVED' %}
                        <span class="badge bg-success">Ù…Ù‚Ø¨ÙˆÙ„</span>
                        {% else %}
                        <span class="badge bg-danger">Ù…Ø±ÙÙˆØ¶</span>
                        {% endif %}
                    </div>
                    {% empty %}
                    <div class="text-center py-4 text-muted">
                        Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª.
                    </div>
                    {% endfor %}
                </div>
                <div class="mt-3 text-center">
                    <button class="btn btn-outline-primary btn-sm w-100">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- AI Analysis Center Section (Added as per request) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold m-0 text-primary">
                        <i class="bi bi-robot me-2"></i> Ù…Ø±ÙƒØ² ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
                    </h5>
                    <!-- Button triggers modal -->
                    <button type="button" class="btn btn-primary rounded-pill px-4 shadow-sm" data-bs-toggle="modal"
                        data-bs-target="#branchSelectionModal">
                        <i class="bi bi-stars me-2"></i> {% trans "ØªØ­Ù„ÙŠÙ„ Ø¬Ø¯ÙŠØ¯" %}
                    </button>
                </div>
                <div class="card-body bg-light bg-opacity-50" id="aiPanelBody">

                    <!-- 1. Empty State -->
                    <div id="aiEmptyState" class="text-center py-5">
                        <div class="mb-3">
                            <i class="bi bi-robot fs-1 text-muted opacity-50"></i>
                        </div>
                        <h5 class="text-muted fw-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ù„ÙŠÙ„Ø§Øª Ø°ÙƒÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹</h5>
                        <p class="text-muted small">Ø§Ø®ØªØ± ÙØ±Ø¹Ø§Ù‹ ÙˆØ§Ø¶ØºØ· "ØªØ­Ù„ÙŠÙ„" Ù„Ø§ÙƒØªØ´Ø§Ù ÙØ±Øµ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù‡Ø¯Ø±</p>
                    </div>

                    <!-- 2. Loading State -->
                    <div id="aiLoadingState" class="text-center py-5 d-none">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h5 class="fw-bold text-primary">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</h5>
                        <p class="text-muted small">ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù‡Ø¯Ø± ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†</p>
                    </div>

                    <!-- 3. Results State -->
                    <div id="aiResultsState" class="d-none animate__animated animate__fadeIn">
                        <div class="row align-items-center">
                            <!-- Chart -->
                            <div class="col-md-4 text-center border-end">
                                <h6 class="text-muted mb-3"><i class="bi bi-pie-chart me-1"></i> ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
                                </h6>
                                <div style="height: 200px; position: relative;" class="d-flex justify-content-center">
                                    <canvas id="aiRiskChart"></canvas>
                                </div>
                                <p class="mt-3 text-muted small">Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ø£ÙƒØ«Ø± Ø¹Ø±Ø¶Ø© Ù„Ù„Ù‡Ø¯Ø± (7 Ø£ÙŠØ§Ù…)</p>
                            </div>

                            <!-- Text Analysis -->
                            <div class="col-md-8 ps-md-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span
                                        class="badge bg-danger bg-opacity-10 text-danger border border-danger px-3 py-2 rounded-pill"
                                        id="aiRiskLevelBadge">High Risk</span>
                                    <small class="text-muted" id="aiDate">00:00 2025-01-01</small>
                                </div>

                                <h5 class="fw-bold mb-3 lh-base" id="aiVerdict">
                                    <!-- Verdict Text -->
                                </h5>

                                <div class="alert alert-light border rounded-3 p-3 mb-0">
                                    <h6 class="fw-bold text-warning mb-2"><i class="bi bi-lightbulb me-2"></i> Ø§Ù„ØªÙˆØµÙŠØ§Øª
                                        Ø§Ù„Ø°ÙƒÙŠØ©:</h6>
                                    <ul class="list-unstyled mb-0" id="aiRecommendations">
                                        <!-- Recommendations List -->
                                    </ul>
                                </div>

                                <div class="mt-3 d-flex justify-content-end align-items-center">
                                    <div class="text-end">
                                        <small class="text-muted d-block">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‡Ø¯Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</small>
                                        <h4 class="fw-bold text-danger m-0" id="aiTotalRisk">0.00 Ø±.Ø³</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Branch Selection -->
    <div class="modal fade" id="branchSelectionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0 shadow">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">Ø§Ø®ØªØ± Ø§Ù„Ù†Ø·Ø§Ù‚ Ù„Ù„ØªØ­Ù„ÙŠÙ„</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small mb-3">Ø­Ø¯Ø¯ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡:</p>
                    <select class="form-select form-select-lg mb-3" id="aiBranchSelect">
                        <option value="" selected>ğŸ¢ ÙƒÙ„ Ø§Ù„Ø´Ø±ÙƒØ© (ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„)</option>
                        {% for branch in branches %}
                        <option value="{{ branch.id }}">ğŸ“ {{ branch.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4" onclick="confirmAIAnalysis()">
                        Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ù„ÙŠÙ„ ğŸš€
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function confirmAIAnalysis() {
            // Get selected branch ID
            const branchId = document.getElementById('aiBranchSelect').value;

            // Hide Modal manually properly
            const modalEl = document.getElementById('branchSelectionModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            // Run Analysis
            runAIAnalysis(branchId);
        }

        async function runAIAnalysis(branchId = "") {
            // UI Updates
            document.getElementById('aiEmptyState').classList.add('d-none');
            document.getElementById('aiResultsState').classList.add('d-none');
            document.getElementById('aiLoadingState').classList.remove('d-none');

            try {
                // Build URL with params
                let url = "{% url 'analytics:magic_ai_advice_api' %}?t=" + new Date().getTime();
                if (branchId) {
                    url += "&branch_id=" + branchId;
                }

                const response = await fetch(url);
                const text = await response.text();

                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    console.error("Non-JSON response:", text);
                    alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… (ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹): " + text.substring(0, 200)); // Show beginning of HTML error
                    resetAIState();
                    return;
                }

                if (data.error) {
                    if (data.error.includes("429") || data.error.includes("Quota")) {
                        alert("âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: ØªÙ… ØªØ¬Ø§ÙˆØ² Ø­Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Quota Exceeded).\nÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.");
                    } else {
                        alert('Ø®Ø·Ø£: ' + data.error);
                    }
                    resetAIState();
                    return;
                }

                // Populate Data
                document.getElementById('aiVerdict').textContent = data.performance_verdict || "ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ù„Ù‡Ø¯Ø±";
                document.getElementById('aiTotalRisk').textContent = (data.financial_impact?.total_risk_value || 0) + ' Ø±.Ø³';
                document.getElementById('aiRiskLevelBadge').textContent = data.financial_impact?.risk_level || 'Normal';

                // Recommendations
                const recList = document.getElementById('aiRecommendations');
                recList.innerHTML = '';
                if (data.recommendations) {
                    data.recommendations.forEach(rec => {
                        const li = document.createElement('li');
                        li.className = 'mb-2 d-flex align-items-start';
                        li.innerHTML = `<i class="bi bi-check-circle-fill text-success me-2 mt-1"></i> <span>${rec}</span>`;
                        recList.appendChild(li);
                    });
                }

                // Chart
                if (data.category_breakdown) {
                    const ctx = document.getElementById('aiRiskChart').getContext('2d');

                    // Destroy old chart if exists (simple check)
                    if (window.aiChartInstance) window.aiChartInstance.destroy();

                    window.aiChartInstance = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(data.category_breakdown),
                            datasets: [{
                                data: Object.values(data.category_breakdown),
                                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false } // Hide legend to match clean look
                            },
                            cutout: '70%'
                        }
                    });
                }

                // Show Results
                document.getElementById('aiLoadingState').classList.add('d-none');
                document.getElementById('aiResultsState').classList.remove('d-none');

            } catch (error) {
                console.error(error);
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ (JS Error): " + error.message);
                resetAIState();
            }
        }

        function resetAIState() {
            document.getElementById('aiLoadingState').classList.add('d-none');
            document.getElementById('aiEmptyState').classList.remove('d-none');
        }
    </script>
</div>
</div>
{% endblock %}